# ========================================
# Caddyfile for Rentverse Backend
# Production: rentverse-backend.jekoyu.dev
# Files stored in S3, no local uploads
# ========================================

# Global options
{
    # Email for Let's Encrypt SSL
    email admin@jekoyu.dev
    
    # Admin API disabled
    admin off
}

# Production domain with Cloudflare DNS
rentverse-backend.jekoyu.dev {
    # Automatic HTTPS via Let's Encrypt
    # Cloudflare DNS challenge (optional - more reliable with Cloudflare)
    # Uncomment if you want to use DNS challenge:
    # tls {
    #     dns cloudflare {env.CLOUDFLARE_API_TOKEN}
    # }

    # Security headers
    header {
        # HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
        -X-Powered-By
    }

    # Compression
    encode gzip zstd

    # Main reverse proxy to backend app
    reverse_proxy app:3000 {
        # Health check
        health_uri /health
        health_interval 30s
        health_timeout 10s
        
        # Headers
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        
        # Timeouts
        transport http {
            dial_timeout 10s
            response_header_timeout 30s
        }
    }

    # Error handling
    handle_errors {
        @unavailable expression `{err.status_code} in [502, 503, 504]`
        handle @unavailable {
            respond "Service temporarily unavailable" 503
        }
        respond "{err.status_code} {err.status_text}"
    }

    # Logging
    log {
        output stdout
        format json
    }
}

# HTTP (port 80) - redirect to HTTPS or for local dev
:80 {
    # For production with domain: redirect to HTTPS
    # redir https://{host}{uri} permanent
    
    # For local development: proxy directly
    reverse_proxy app:3000
}
