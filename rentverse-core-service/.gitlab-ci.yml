include:
  - template: SAST.gitlab-ci.yml
  - template: Secret-Detection.gitlab-ci.yml

image: node:20

stages:
  - install
  - validate
  - test
  - deploy

cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - node_modules/
    - .pnpm-store/
  policy: pull-push

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH == 'main' || $CI_COMMIT_BRANCH == 'staging'
    - if: $CI_PIPELINE_SOURCE == 'web'

# =========================
# INSTALL
# =========================
install_dependencies:
  stage: install
  script:
    - npm install -g pnpm
    - pnpm install --frozen-lockfile

# =========================
# VALIDATE
# =========================
validate_code:
  stage: validate
  needs: [install_dependencies]
  script:
    - npm install -g pnpm
    - pnpm run lint
    - pnpm run db:generate

# =========================
# TEST (opsional, contoh)
# =========================
test_app:
  stage: test
  needs: [install_dependencies]
  script:
    - npm install -g pnpm
    - pnpm run test || echo "No tests yet"

# =========================
# DEPLOY (PRODUCTION)
# =========================
deploy_production:
  stage: deploy
  image: alpine:latest
  needs:
    - validate_code
    - test_app
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  before_script:
    - apk add --no-cache openssh rsync
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan -p ${SSH_PORT:-22} $SSH_HOST >> ~/.ssh/known_hosts
  script:
    # Deploy files to server (exclude .env to preserve server config)
    - rsync -avz --delete --exclude='.git/' --exclude='node_modules/' --exclude='.env' --exclude='uploads/' --exclude='.gitlab-ci.yml' ./ $SSH_USER@$SSH_HOST:~/apps/rentverse-backend/

    # Run docker compose on server
    - ssh $SSH_USER@$SSH_HOST "cd ~/apps/rentverse-backend && docker compose down && docker compose up -d --build"
